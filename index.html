<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper æ•¸å­¸æ¨¡æ“¬è©¦å· V7.0 (Past Paper å¼·åŒ–ç‰ˆ)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Roboto+Mono:wght@500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f9ff; user-select: none; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .digit-input { width: 100%; height: 100%; text-align: center; font-family: 'Roboto Mono', monospace; font-weight: 700; font-size: 1.5rem; border: 2px solid #cbd5e1; border-radius: 0.5rem; background-color: white; color: #1e293b; transition: all 0.2s; }
        .digit-input:focus { border-color: #6366f1; outline: none; background-color: #eef2ff; transform: scale(1.05); z-index: 10; }
        .digit-input:disabled { background-color: #f8fafc; border-color: #e2e8f0; color: #94a3b8; }
        /* ç®—è‰æ ¼ï¼šä½æ–¼æ©«ç·šä¸Šæ–¹ */
        .carry-input { width: 100%; height: 28px; text-align: center; font-size: 0.9rem; font-weight: bold; color: #ef4444; background-color: transparent; border: 1px dashed #fda4af; border-radius: 4px; z-index: 5; margin-bottom: 2px; }
        .calc-line { height: 4px; background-color: #334155; border-radius: 2px; margin-top: 2px; margin-bottom: 4px; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @keyframes popUp { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .praise-anim { animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = {
            Clock: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Calc: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Check: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>,
            Brain: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Alert: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Scale: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>
        };

        const PRAISE_WORDS = ["å¤ªæ£’äº†ï¼", "Jasper å¥½é‡ï¼", "å®Œå…¨æ­£ç¢ºï¼", "åšå¾—å¥½ï¼", "æ•¸å­¸å¤©æ‰ï¼", "ç¹¼çºŒåŠ æ²¹ï¼"];

        // --- è¦–è¦ºçµ„ä»¶ï¼šç£… (Scale) ---
        const ScaleView = ({ weight, max = 5000, unit = 'g' }) => {
            // è¨ˆç®—è§’åº¦ï¼šå‡è¨­ 0 åœ¨é ‚éƒ¨ (-90åº¦)ï¼Œæœ€å¤§å€¼è½‰ 360 åº¦
            const rotation = (weight / max) * 360; 
            return (
                <div className="flex flex-col items-center my-4">
                    <div className="relative w-40 h-40">
                        {/* ç£…èº« */}
                        <div className="absolute inset-0 rounded-full border-4 border-slate-700 bg-white flex items-center justify-center shadow-lg">
                            {/* åˆ»åº¦ (ç°¡åŒ–) */}
                            {[0, 45, 90, 135, 180, 225, 270, 315].map(d => (
                                <div key={d} className="absolute w-full h-full" style={{transform: `rotate(${d}deg)`}}>
                                    <div className="w-1 h-3 bg-slate-300 mx-auto"></div>
                                </div>
                            ))}
                            <div className="absolute top-2 text-xs font-bold text-slate-400">0</div>
                            <div className="absolute bottom-2 text-xs font-bold text-slate-400">{max/2}</div>
                        </div>
                        {/* æŒ‡é‡ */}
                        <div className="absolute inset-0 flex items-center justify-center" style={{transform: `rotate(${rotation}deg)`, transition: 'transform 1s ease-out'}}>
                            <div className="w-1 h-16 bg-red-500 origin-bottom transform -translate-y-1/2 rounded-full"></div>
                        </div>
                        {/* ä¸­å¿ƒé» */}
                        <div className="absolute inset-0 flex items-center justify-center">
                            <div className="w-3 h-3 bg-slate-800 rounded-full"></div>
                        </div>
                    </div>
                    <div className="mt-2 font-bold text-slate-500 text-sm">æœ€å¤§ç¨±é‡: {max}{unit}</div>
                </div>
            );
        };

        // --- è¦–è¦ºçµ„ä»¶ï¼šé‡æ¯ (Beaker) ---
        const BeakerView = ({ capacity, level, label }) => {
            const heightPerc = (level / capacity) * 100;
            return (
                <div className="flex flex-col items-center mx-4">
                    <div className="relative w-24 h-32 border-b-4 border-x-4 border-slate-700 rounded-b-xl bg-white overflow-hidden">
                        {/* æ°´ */}
                        <div className="absolute bottom-0 w-full bg-blue-400 opacity-80 transition-all duration-1000" style={{height: `${heightPerc}%`}}></div>
                        {/* åˆ»åº¦ */}
                        <div className="absolute right-0 top-0 h-full w-full flex flex-col justify-between py-2 px-2 items-end">
                            <div className="w-3 h-0.5 bg-slate-800"></div>
                            <div className="w-3 h-0.5 bg-slate-800"></div>
                            <div className="w-3 h-0.5 bg-slate-800"></div>
                            <div className="w-3 h-0.5 bg-slate-800"></div>
                        </div>
                        <div className="absolute top-2 left-2 font-bold text-xs text-slate-500">{capacity}mL</div>
                    </div>
                    <div className="mt-2 font-bold text-slate-700">{label}</div>
                </div>
            );
        };

        // --- è¦–è¦ºçµ„ä»¶ï¼šç®—æŸ± (Abacus) ---
        const AbacusView = ({ number }) => {
            const digits = number.toString().padStart(5, '0').split('');
            const places = ['è¬', 'åƒ', 'ç™¾', 'å', 'å€‹'];
            return (
                <div className="flex justify-center gap-2 my-4 bg-amber-50 p-4 rounded-xl border border-amber-200">
                    {digits.map((d, i) => (
                        <div key={i} className="flex flex-col items-center">
                            <div className="h-24 w-1 bg-slate-400 relative mb-1">
                                {[...Array(parseInt(d))].map((_, j) => (
                                    <div key={j} className="absolute w-6 h-4 bg-amber-600 rounded-full left-1/2 transform -translate-x-1/2 border border-amber-800 shadow-sm" style={{bottom: j * 18}}></div>
                                ))}
                            </div>
                            <div className="w-8 h-8 flex items-center justify-center border-2 border-slate-600 bg-white font-bold text-slate-700 rounded shadow-sm">{places[i]}</div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- è¦–è¦ºçµ„ä»¶ï¼šè±¡å½¢åœ– (Pictogram) ---
        const PictogramView = ({ data, title }) => {
            return (
                <div className="my-4 w-full">
                    <div className="text-center font-bold text-lg mb-4 border-2 border-slate-300 p-2 rounded-lg bg-white mx-auto w-3/4">{title || "ï¼ˆæ¨™é¡Œï¼‰"}</div>
                    <div className="text-right text-xs font-bold mb-2">æ¯å€‹ ğŸ”µ ä»£è¡¨ 1 äºº</div>
                    <div className="flex justify-around items-end h-48 border-b-2 border-slate-800 pb-2 px-2">
                        {data.map((item, i) => (
                            <div key={i} className="flex flex-col items-center gap-1">
                                {[...Array(item.value)].map((_, j) => (
                                    <div key={j} className="w-5 h-5 rounded-full bg-blue-500 border border-blue-700 shadow-sm"></div>
                                ))}
                                <div className="mt-2 text-xs font-bold writing-mode-vertical text-slate-700">{item.name}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 1. æ¨™æº–ç›´å¼ ---
        const VerticalAddSub = ({ n1, n2, op, onComplete }) => {
            const digits1 = n1.toString().padStart(4, ' ').split('');
            const digits2 = n2.toString().padStart(4, ' ').split('');
            const [inputs, setInputs] = useState(['', '', '', '']);
            const [carries, setCarries] = useState(['', '', '', '']);
            const [errorMsg, setErrorMsg] = useState('');
            const correctAns = op === '+' ? n1 + n2 : n1 - n2;
            const correctDigits = correctAns.toString().padStart(4, ' ').split('');

            const checkAnswer = () => {
                let userNumStr = inputs.map(d => d === '' ? ' ' : d).join('');
                if (parseInt(userNumStr.replace(/\s/g, '')) === correctAns) onComplete(correctAns);
                else setErrorMsg('å°å¿ƒï¼æª¢æŸ¥ä½ çš„ç­”æ¡ˆå’Œç®—è‰ã€‚');
            };

            return (
                <div className="bg-white p-6 rounded-2xl border-2 border-slate-200 shadow-sm max-w-sm mx-auto animate-in zoom-in-95">
                    <div className="grid grid-cols-5 gap-1 font-mono">
                        <div className="col-span-1"></div>{digits1.map((d, i) => <div key={`d1-${i}`} className="h-10 flex items-center justify-center text-3xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-1 text-3xl font-black text-slate-400">{op}</div>{digits2.map((d, i) => <div key={`d2-${i}`} className="h-10 flex items-center justify-center text-3xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-1"></div>{carries.map((v, i) => (<div key={`c-${i}`} className="flex items-end justify-center"><input className="carry-input" value={v} placeholder="." onChange={e=>setCarries(p=>{const n=[...p];n[i]=e.target.value.slice(-2);return n;})} /></div>))}
                        <div className="col-span-5 calc-line"></div>
                        <div className="col-span-1"></div>{inputs.map((v, i) => (<input key={`in-${i}`} type="number" className={`digit-input h-14 ${v!=='' && correctDigits[i]!==' ' && v!==correctDigits[i] ? 'bg-red-50 border-red-300 text-red-600' : ''}`} value={v} disabled={correctDigits[i]===' '} onChange={e => {setInputs(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;}); setErrorMsg('');}} />))}
                    </div>
                    {errorMsg && <div className="mt-3 text-center text-rose-500 font-bold text-sm bg-rose-50 p-2 rounded">{errorMsg}</div>}
                    <button onClick={checkAnswer} className="mt-5 w-full bg-indigo-600 text-white py-3 rounded-xl font-black shadow-md active:scale-95 transition-all">æª¢æŸ¥ç­”æ¡ˆ</button>
                </div>
            );
        };

        // --- 2. é€£å¼ç›´å¼ ---
        const VerticalContinuous = ({ n1, n2, n3, op1, op2, onComplete }) => {
            const digits1 = n1.toString().padStart(4, ' ').split('');
            const digits2 = n2.toString().padStart(4, ' ').split('');
            const digits3 = n3.toString().padStart(4, ' ').split('');
            const step1Ans = op1 === '+' ? n1 + n2 : n1 - n2;
            const digitsStep1 = step1Ans.toString().padStart(4, ' ').split('');
            const finalAns = op2 === '+' ? step1Ans + n3 : step1Ans - n3;
            const digitsFinal = finalAns.toString().padStart(4, ' ').split('');
            const [inputs1, setInputs1] = useState(['', '', '', '']); const [carries1, setCarries1] = useState(['', '', '', '']);
            const [inputs2, setInputs2] = useState(['', '', '', '']); const [carries2, setCarries2] = useState(['', '', '', '']);
            const [errorMsg, setErrorMsg] = useState('');

            const checkAnswer = () => {
                let u1 = parseInt(inputs1.map(d => d===''?' ':d).join('').replace(/\s/g, ''));
                let u2 = parseInt(inputs2.map(d => d===''?' ':d).join('').replace(/\s/g, ''));
                if (u1 !== step1Ans) { setErrorMsg('ç¬¬ä¸€æ­¥ç®—éŒ¯äº† (ä¸­é–“)'); return; }
                if (u2 !== finalAns) { setErrorMsg('æœ€å¾Œç­”æ¡ˆç®—éŒ¯äº†'); return; }
                onComplete(finalAns);
            };

            return (
                <div className="bg-white p-6 rounded-2xl border-2 border-slate-200 shadow-sm max-w-sm mx-auto animate-in zoom-in-95">
                    <div className="grid grid-cols-5 gap-1 font-mono">
                        <div className="col-span-1"></div>{carries1.map((v, i) => <input key={`c1-${i}`} className="carry-input" value={v} onChange={e=>setCarries1(p=>{const n=[...p];n[i]=e.target.value.slice(-2);return n;})} />)}
                        <div className="col-span-1"></div>{digits1.map((d, i) => <div key={`d1-${i}`} className="h-8 flex items-center justify-center text-2xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-1 text-2xl font-black text-slate-400">{op1}</div>{digits2.map((d, i) => <div key={`d2-${i}`} className="h-8 flex items-center justify-center text-2xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-5 calc-line"></div>
                        <div className="col-span-1"></div>{inputs1.map((v, i) => <input key={`in1-${i}`} type="number" className={`digit-input h-10 ${v!=='' && digitsStep1[i]!==' ' && v!==digitsStep1[i] ? 'bg-red-50 border-red-300' : ''}`} value={v} disabled={digitsStep1[i]===' '} onChange={e => {setInputs1(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;}); setErrorMsg('');}} />)}
                        <div className="col-span-1"></div>{carries2.map((v, i) => <input key={`c2-${i}`} className="carry-input mt-2" value={v} onChange={e=>setCarries2(p=>{const n=[...p];n[i]=e.target.value.slice(-2);return n;})} />)}
                        <div className="col-span-1 text-2xl font-black text-slate-400 mt-2">{op2}</div>{digits3.map((d, i) => <div key={`d3-${i}`} className="h-8 flex items-center justify-center text-2xl font-black text-slate-700 mt-2">{d}</div>)}
                        <div className="col-span-5 calc-line"></div>
                        <div className="col-span-1"></div>{inputs2.map((v, i) => <input key={`in2-${i}`} type="number" className={`digit-input h-10 ${v!=='' && digitsFinal[i]!==' ' && v!==digitsFinal[i] ? 'bg-red-50 border-red-300' : ''}`} value={v} disabled={digitsFinal[i]===' '} onChange={e => {setInputs2(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;}); setErrorMsg('');}} />)}
                    </div>
                    {errorMsg && <div className="mt-3 text-center text-rose-500 font-bold text-sm bg-rose-50 p-2 rounded">{errorMsg}</div>}
                    <button onClick={checkAnswer} className="mt-5 w-full bg-indigo-600 text-white py-3 rounded-xl font-black shadow-md active:scale-95 transition-all">æª¢æŸ¥å…¨å¼</button>
                </div>
            );
        };

        // --- 3. ç›´å¼ä¹˜æ³• ---
        const VerticalMulti = ({ n1, n2, onComplete }) => {
            const digits1 = n1.toString().padStart(3, ' ').split('');
            const [inputs, setInputs] = useState(['', '', '', '']); const [carries, setCarries] = useState(['', '', '']);
            const [errorMsg, setErrorMsg] = useState('');
            const correctAns = n1 * n2;
            const correctDigits = correctAns.toString().padStart(4, ' ').split('');

            const checkAnswer = () => {
                let userNumStr = inputs.map(d => d === '' ? ' ' : d).join('');
                if (parseInt(userNumStr.replace(/\s/g, '')) === correctAns) onComplete(correctAns);
                else setErrorMsg('ä¹˜æ³•ç®—éŒ¯å›‰ï¼é€²ä½å¯«åœ¨ä¸Šé¢ã€‚');
            };

            return (
                <div className="bg-white p-6 rounded-2xl border-2 border-slate-200 shadow-sm max-w-sm mx-auto animate-in zoom-in-95">
                    <div className="grid grid-cols-5 gap-2 font-mono">
                        <div className="col-span-2"></div>{carries.map((v, i) => <input key={i} className="carry-input" placeholder="é€²" value={v} onChange={e=>setCarries(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;})} />)}
                        <div className="col-span-2"></div>{digits1.map((d, i) => <div key={i} className="h-10 flex items-center justify-center text-3xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-1 text-right text-3xl font-black text-slate-400 mr-2">Ã—</div><div className="col-span-3"></div><div className="col-span-1 h-10 flex items-center justify-center text-3xl font-black text-slate-700">{n2}</div>
                        <div className="col-span-5 calc-line"></div>
                        <div className="col-span-1"></div>{inputs.map((v, i) => <input key={i} type="number" className={`digit-input ${v!=='' && correctDigits[i]!==' ' && v!==correctDigits[i] ? 'bg-red-50 border-red-300 text-red-600' : ''}`} value={v} disabled={correctDigits[i]===' '} placeholder={correctDigits[i]===' '?'':'?'} onChange={e => {setInputs(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;}); setErrorMsg('');}} />)}
                    </div>
                    {errorMsg && <div className="mt-3 text-center text-rose-500 font-bold text-sm bg-rose-50 p-2 rounded">{errorMsg}</div>}
                    <button onClick={checkAnswer} className="mt-5 w-full bg-indigo-600 text-white py-3 rounded-xl font-black shadow-md active:scale-95 transition-all">æª¢æŸ¥ç­”æ¡ˆ</button>
                </div>
            );
        };

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼š37é¡Œ é¡Œç›®ç”Ÿæˆå™¨ ---
        const generateQuizData = () => {
            const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);

            // é¡Œåº«æ± ï¼šåŒ…å« Past Paper æ‰€æœ‰é¡Œå‹
            const pool = [
                // Q2: æ’åˆ—
                (() => { const base = rand(30000, 39000); const n1=base, n2=base+rand(10,100), n3=base-rand(10,100); const sorted=[n3, n1, n2].sort((a,b)=>a-b); return { id: 2, title: 'æ•¸å­—æ’åˆ—', text: `è«‹æŠŠ ${n1}, ${n2}, ${n3} ç”±å°è‡³å¤§æ’åˆ—`, steps: [{type:'INPUT_CHECK', label: 'æœ€å°çš„æ•¸', correct: sorted[0].toString()}, {type:'INPUT_CHECK', label: 'ä¸­é–“çš„æ•¸', correct: sorted[1].toString()}, {type:'INPUT_CHECK', label: 'æœ€å¤§çš„æ•¸', correct: sorted[2].toString()}]}; })(),
                // Q3: ç®—æŸ± (ç”¨ AbacusView)
                (() => { const n = rand(10000, 99999); return { id: 3, title: 'ç®—æŸ±', text: `åœ–ä¸­çš„ç®—æŸ±è¡¨ç¤ºç”šéº¼æ•¸ï¼Ÿ`, isAbacus: true, val: n, steps: [{type:'INPUT_CHECK', label: 'é€™å€‹æ•¸æ˜¯ï¼Ÿ', correct: n.toString()}] }; })(),
                // Q4: æ¸›æ³•
                (() => { const a=rand(5000,9000), b=rand(1000,4000); return { id: 4, title: 'å››ä½æ•¸æ¸›æ³•', text: `${a} - ${b} = ?`, steps: [{type:'SUB', n1:a, n2:b, hint:'ç›´å¼è¨ˆç®—'}] }; })(),
                // Q5: åŠ æ³•
                (() => { const a=rand(1000,4000), b=rand(2000,5000); return { id: 5, title: 'å››ä½æ•¸åŠ æ³•', text: `${a} + ${b} = ?`, steps: [{type:'ADD', n1:a, n2:b, hint:'ç›´å¼è¨ˆç®—'}] }; })(),
                // Q6: éŒ¢å¹£æ¸›æ³• (è½‰åŒ–ç‚ºæ¯«å­ç®—)
                (() => { const total=300, a=44, b=127; return { id: 6, title: 'è²¨å¹£é‹ç®—', text: '$30 - ($4.4 + $12.7) = ?', steps: [{type:'LOGIC', text: 'å…ˆç®—æ‹¬å¼§å…§çš„ç¸½èŠ±è²»', options: shuffle(['$4.4 + $12.7', '$30 - $4.4']), ans: '$4.4 + $12.7'}, {type:'ADD', n1:44, n2:127, hint:'44è§’ + 127è§’ (ä»¥è§’è¨ˆç®—)'}, {type:'SUB', n1:300, n2:171, hint:'300è§’ - 171è§’'}] }; })(),
                // Q7: é€£ä¹˜
                (() => { const a=20, b=rand(2,9), c=5; return { id: 7, title: 'é€£ä¹˜æ³•', text: `${a} Ã— ${b} Ã— ${c} = ?`, steps: [{type:'LOGIC', text: 'å·§ç®—ï¼šå…ˆç®—å“ªå…©å€‹æ•¸æ¯”è¼ƒå¿«ï¼Ÿ', options: shuffle([`${a} Ã— ${c}`, `${a} Ã— ${b}`, `${b} Ã— ${c}`]), ans: `${a} Ã— ${c}`}, {type:'INPUT_CHECK', label: `${a} Ã— ${c} = ?`, correct: '100'}, {type:'INPUT_CHECK', label: `100 Ã— ${b} = ?`, correct: (100*b).toString()}] }; })(),
                // Q8: é€†å‘é‹ç®— (ä»£æ•¸æ€ç¶­) 4037 + 3219 - ? = 2717 => 7256 - ? = 2717 => ? = 7256 - 2717
                (() => { const a=4037, b=3219, target=2717; return { id: 8, title: 'é€†å‘æ€è€ƒ', text: `${a} + ${b} - ? = ${target}`, steps: [{type:'ADD', n1:a, n2:b, hint:'å…ˆç®—å‰é¢åŠ æ³•'}, {type:'LOGIC', text: `7256 - ? = ${target}ï¼Œæ‰€ä»¥ ? ç­‰æ–¼`, options: shuffle([`7256 - ${target}`, `7256 + ${target}`]), ans: `7256 - ${target}`}, {type:'SUB', n1:a+b, n2:target, hint:'æ‰¾å‡ºå•è™Ÿçš„æ•¸'}] }; })(),
                // Q9: é€£åŠ æ–‡å­—é¡Œ (åœ–æ›¸é¤¨)
                (() => { const a=1062, b=3131, c=1508; return { id: 9, title: 'åœ–æ›¸ç¸½æ•¸', text: `ç¬¬ä¸€å±¤æœ‰ ${a} æœ¬ï¼Œç¬¬äºŒå±¤ ${b} æœ¬ï¼Œç¬¬ä¸‰å±¤ ${c} æœ¬ã€‚å…±æœ‰å¤šå°‘ï¼Ÿ`, steps: [{type:'CONTINUOUS', n1:a, n2:b, n3:c, op1:'+', op2:'+', hint:'é€£å¼åŠ æ³•'}] }; })(),
                // Q10: æ‰¾è´– (å¸å¡µæ©Ÿ)
                (() => { const pay=5000, cost=2016; return { id: 10, title: 'æ‰¾è´–å•é¡Œ', text: `è²·å…©éƒ¨å¸å¡µæ©Ÿ(æ¯éƒ¨$${cost})ï¼Œä»˜$${pay}ï¼Œæ‰¾å›å¤šå°‘ï¼Ÿ`, steps: [{type:'MULTI', n1:2016, n2:2, hint:'å…ˆç®— 2 éƒ¨çš„åƒ¹éŒ¢'}, {type:'SUB', n1:5000, n2:4032, hint:'ç”¨ 5000 æ¸›å»ç¸½åƒ¹'}] }; })(),
                // Q11: é€£æ¸›
                (() => { const a=1356, b=444, c=44; return { id: 11, title: 'é€£æ¸›æ³•', text: `${a} - ${b} - ${c} = ?`, steps: [{type:'CONTINUOUS', n1:a, n2:b, n3:c, op1:'-', op2:'-', hint:'é€£å¼æ¸›æ³•'}] }; })(),
                // Q12: æ‹¬è™Ÿæ¸›æ³•
                (() => { const a=654, b=228, c=97; return { id: 12, title: 'æ‹¬è™Ÿæ¸›æ³•', text: `${a} - (${b} + ${c}) = ?`, steps: [{type:'ADD', n1:b, n2:c, hint:'å…ˆç®—æ‹¬å¼§'}, {type:'SUB', n1:a, n2:b+c, hint:'å†ç”¨ç¸½æ•¸æ¸›'}] }; })(),
                // Q14: é™¤æ³•ä¼°ç®—
                { id: 14, title: 'é™¤æ³•ä¼°ç®—', text: 'ã€Œ ? Ã· 6 = 45 ... 2 ã€ï¼Œ? çš„ç™¾ä½æ•¸å­—æ˜¯ï¼Ÿ', steps: [{type:'LOGIC', text: 'è¢«é™¤æ•¸ = å•† Ã— é™¤æ•¸ + é¤˜æ•¸', options: ['45 Ã— 6 + 2', '45 Ã· 6'], ans: '45 Ã— 6 + 2'}, {type:'MULTI', n1:45, n2:6, hint:'è¨ˆç®— 45 Ã— 6'}, {type:'INPUT_CHECK', label: '270 + 2 = ?', correct: '272'}, {type:'INPUT_CHECK', label: 'ç™¾ä½æ•¸å­—æ˜¯ï¼Ÿ', correct: '2'}] },
                // Q15: é™¤æ³•
                (() => { const a=613, b=3; return { id: 15, title: 'é™¤æ³•è¨ˆç®—', text: `${a} Ã· ${b} = ?`, steps: [{type:'LOGIC', text: '600 Ã· 3 = 200ï¼Œ13 Ã· 3 = 4...1', options: ['204...1', '24...1'], ans: '204...1'}] }; })(),
                // Q18: æ¯”è¼ƒé¡Œ (è¤‡é›œ)
                (() => { const dad=2942, mom=2203, diff1=172; return { id: 18, title: 'æ¯”è¼ƒé¡Œ (é€²éš)', text: `çˆ¸$${dad}ï¼Œåª½$${mom}ã€‚åª½æ¯”è¡¨å§å°‘$${diff1}ã€‚å•çˆ¸æ¯”è¡¨å§å¤šå¹¾å…ƒï¼Ÿ`, steps: [
                    {type:'LOGIC', text: 'Step 1: åª½æ¯”è¡¨å§å°‘ = è¡¨å§æ¯”åª½å¤šã€‚è¡¨å§æœ‰å¤šå°‘ï¼Ÿ', options: [`${mom} + ${diff1}`, `${mom} - ${diff1}`], ans: `${mom} + ${diff1}`},
                    {type:'ADD', n1:mom, n2:diff1, hint:'è¨ˆç®—è¡¨å§çš„éŒ¢'}, // 2375
                    {type:'LOGIC', text: `è¡¨å§æœ‰ $${mom+diff1}ã€‚çˆ¸æœ‰ $${dad}ã€‚çˆ¸æ¯”è¡¨å§å¤šå¤šå°‘ï¼Ÿ`, options: [`${dad} - ${mom+diff1}`, `${mom+diff1} - ${dad}`], ans: `${dad} - ${mom+diff1}`},
                    {type:'SUB', n1:dad, n2:mom+diff1, hint:'è¨ˆç®—å·®é¡'}
                ] }; })(),
                // Q21: ç£…é‡ (ScaleView)
                (() => { const w=rand(4100, 4900); return { id: 21, title: 'é–±è®€ç£…é‡', text: 'è¥¿ç“œé‡å¤šå°‘å…‹ï¼Ÿ', isScale: true, val: w, max: 5000, unit: 'g', steps: [{type:'INPUT_CHECK', label: 'è®€æ•¸æ˜¯(g)ï¼Ÿ', correct: w.toString()}] }; })(),
                // Q22: ç£…é‡ (å°å–®ä½)
                (() => { const w=rand(600, 700); return { id: 22, title: 'é–±è®€ç£…é‡ II', text: 'ä¸€åŒ…æ›²å¥‡é‡å¤šå°‘ï¼Ÿ', isScale: true, val: w, max: 1000, unit: 'g', steps: [{type:'INPUT_CHECK', label: 'è®€æ•¸æ˜¯(g)ï¼Ÿ', correct: w.toString()}] }; })(),
                // Q23: ä»£æ›é‚è¼¯
                { id: 23, title: 'å¤©å¹³ä»£æ›', text: '1 ç½é ­ = 2 æ­£æ–¹é«”ã€‚1 è¥¿ç“œ = 1 ç½é ­ + 2 æ­£æ–¹é«”ã€‚å• 2 è¥¿ç“œ = ? ç½é ­', steps: [
                    {type:'LOGIC', text: '1 è¥¿ç“œ = 1 ç½é ­ + 2 æ­£æ–¹é«”ã€‚æ—¢ç„¶ 2 æ­£æ–¹é«” = 1 ç½é ­ï¼Œé‚£ 1 è¥¿ç“œ = ? ç½é ­', options: ['2 ç½é ­', '3 ç½é ­'], ans: '2 ç½é ­'},
                    {type:'INPUT_CHECK', label: '1 è¥¿ç“œ = 2 ç½é ­ï¼Œé‚£ 2 è¥¿ç“œ = ?', correct: '4'}
                ]},
                // Q26: é‡æ¯ (BeakerView)
                (() => { const cap=1000, lvl=800; return { id: 26, title: 'å®¹é‡é–±è®€', text: 'å®¹å™¨ Q çš„å®¹é‡æ˜¯ï¼Ÿ', isBeaker: true, cap: cap, lvl: lvl, steps: [{type:'INPUT_CHECK', label: 'æ°´ä½æ˜¯(mL)ï¼Ÿ', correct: lvl.toString()}] }; })(),
                // Q27: å–®ä½æ›ç®—
                { id: 27, title: 'å–®ä½æ›ç®—', text: '20 å…¬æ–¤ 20 å…‹ = ? å…‹', steps: [
                    {type:'LOGIC', text: '1 å…¬æ–¤ = 1000 å…‹ã€‚20 å…¬æ–¤ = ?', options: ['20000', '200'], ans: '20000'},
                    {type:'INPUT_CHECK', label: '20000 + 20 = ?', correct: '20020'}
                ]},
                // Q37: è±¡å½¢åœ–
                (() => {
                    const data = [
                        {name: 'æ¸¸æ³³', value: rand(3,8)}, {name: 'é›»è…¦', value: rand(2,6)}, {name: 'æ²¹ç•«', value: rand(4,9)}
                    ];
                    return { id: 37, title: 'è±¡å½¢åœ–åˆ†æ', text: 'åˆ†æ 3E ç­èˆˆè¶£ç­äººæ•¸', isPictogram: true, data: data, steps: [
                        {type:'INPUT_CHECK', label: `é¸æ“‡${data[0].name}çš„äººæ•¸`, correct: data[0].value.toString()},
                        {type:'INPUT_CHECK', label: `é¸æ“‡${data[2].name}çš„äººæ•¸`, correct: data[2].value.toString()},
                        {type:'LOGIC', text: `${data[0].name} æ¯” ${data[1].name} å¤šå¹¾äººï¼Ÿ`, options: [`${data[0].value} - ${data[1].value}`, `${data[0].value} + ${data[1].value}`], ans: `${data[0].value} - ${data[1].value}`},
                        {type:'INPUT_CHECK', label: 'ç­”æ¡ˆæ˜¯ï¼Ÿ', correct: (data[0].value - data[1].value).toString()}
                    ]};
                })()
            ];

            // å¾æ± ä¸­éš¨æ©ŸæŠ½å– 20 é¡Œï¼Œä¸¦æ‰“äº‚æ¬¡åº
            const selected = shuffle(pool).slice(0, 20); 
            return selected;
        };

        const App = () => {
            const [mode, setMode] = useState('MENU');
            const [questions, setQuestions] = useState([]);
            const [qIndex, setQIndex] = useState(0);
            const [stepIndex, setStepIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [mistakeList, setMistakeList] = useState([]); 
            const [praise, setPraise] = useState('');

            const startQuiz = () => {
                const newQs = generateQuizData();
                setQuestions(newQs);
                setQIndex(0); setStepIndex(0); setScore(0); setMistakeList([]); setMode('GAME');
            };

            const currentQ = questions[qIndex] || {};
            const currentStep = currentQ.steps ? currentQ.steps[stepIndex] : {};
            const progress = questions.length > 0 ? ((qIndex) / questions.length) * 100 : 0;

            const showPraise = () => {
                setPraise(PRAISE_WORDS[Math.floor(Math.random() * PRAISE_WORDS.length)]);
                setTimeout(() => setPraise(''), 1500);
            };

            const nextStep = () => {
                if (stepIndex < currentQ.steps.length - 1) setStepIndex(p => p + 1);
                else {
                    if (qIndex < questions.length - 1) { setQIndex(q => q + 1); setStepIndex(0); } 
                    else setMode('RESULT');
                }
            };

            const handleLogicChoice = (opt) => {
                if (opt === currentStep.ans) { showPraise(); nextStep(); }
                else { alert(`é¸éŒ¯äº†ï¼è©¦è©¦å…¶ä»–çš„ã€‚`); setMistakeList([...mistakeList, currentQ.title]); }
            };

            const handleCalcComplete = () => { showPraise(); nextStep(); };
            const handleInputCheck = (val) => {
                if (val.trim() === currentStep.correct) { showPraise(); nextStep(); }
                else { alert(`ç­”æ¡ˆä¸å°å–”ï¼`); setMistakeList([...mistakeList, currentQ.title]); }
            };

            const renderStep = () => {
                const k = `${qIndex}-${stepIndex}`;
                switch(currentStep.type) {
                    case 'LOGIC': return <div key={k} className="grid gap-4 animate-in slide-in-from-right"><div className="bg-indigo-50 p-4 rounded-xl text-indigo-800 font-bold flex gap-2"><Icon.Brain/> {currentStep.text}</div>{currentStep.options.map((o,i)=><button key={i} onClick={()=>handleLogicChoice(o)} className="p-4 border-2 border-slate-200 rounded-xl font-bold hover:bg-indigo-100 text-left">{o}</button>)}</div>;
                    case 'ADD': case 'SUB': return <div key={k} className="animate-in zoom-in-95"><div className="bg-emerald-50 p-2 rounded mb-4 text-center font-bold text-emerald-800">{currentStep.hint}</div><VerticalAddSub n1={currentStep.n1} n2={currentStep.n2} op={currentStep.type==='ADD'?'+':'-'} onComplete={handleCalcComplete} /></div>;
                    case 'MULTI': return <div key={k} className="animate-in zoom-in-95"><div className="bg-emerald-50 p-2 rounded mb-4 text-center font-bold text-emerald-800">{currentStep.hint}</div><VerticalMulti n1={currentStep.n1} n2={currentStep.n2} onComplete={handleCalcComplete} /></div>;
                    case 'CONTINUOUS': return <div key={k} className="animate-in zoom-in-95"><div className="bg-purple-50 p-2 rounded mb-4 text-center font-bold text-purple-800">{currentStep.hint}</div><VerticalContinuous n1={currentStep.n1} n2={currentStep.n2} n3={currentStep.n3} op1={currentStep.op1} op2={currentStep.op2} onComplete={handleCalcComplete} /></div>;
                    case 'INPUT_CHECK': return <div key={k} className="flex flex-col gap-4 animate-in slide-in-from-right"><label className="font-bold text-slate-700">{currentStep.label}</label><input type="text" className="p-4 border-2 border-slate-300 rounded-xl text-center text-2xl font-black" placeholder="è¼¸å…¥ç­”æ¡ˆ" onKeyDown={(e)=>{if(e.key==='Enter') handleInputCheck(e.target.value)}} /><button className="bg-slate-800 text-white p-4 rounded-xl font-black" onClick={(e)=>handleInputCheck(e.target.previousSibling.value)}>ç¢ºå®š</button></div>;
                    default: return null;
                }
            };

            if (mode === 'MENU') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white rounded-[2.5rem] p-10 max-w-lg w-full shadow-2xl text-center border border-slate-100">
                        <div className="inline-block p-4 bg-indigo-100 rounded-full text-indigo-600 mb-6"><Icon.Brain/></div>
                        <h1 className="text-3xl font-black text-slate-800 mb-2">Jasper æ•¸å­¸ V7.0</h1>
                        <p className="text-indigo-500 font-bold mb-8 uppercase tracking-widest">Past Paper å®Œæ•´ç‰¹è¨“ç‰ˆ</p>
                        <div className="text-left bg-slate-50 p-6 rounded-2xl mb-8 space-y-2 text-slate-600 font-bold text-sm">
                            <p>ğŸ¯ åŒ…å« Past Paper 37 é¡é¡Œå‹</p>
                            <p>ğŸ² æ¯æ¬¡éš¨æ©ŸæŠ½å‡º 20 é¡Œç‰¹è¨“</p>
                            <p>âš–ï¸ ç£…é‡ã€é‡æ¯ã€åœ–å½¢å…¨è¦†è“‹</p>
                        </div>
                        <button onClick={startQuiz} className="w-full bg-indigo-600 text-white text-xl font-black py-5 rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all">é–‹å§‹æŒ‘æˆ°</button>
                    </div>
                </div>
            );

            if (mode === 'RESULT') {
                const uniqueMistakes = [...new Set(mistakeList)];
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white rounded-[2.5rem] p-10 max-w-lg w-full shadow-2xl text-center border border-slate-100 animate-in zoom-in-95">
                            <h2 className="text-4xl font-black text-slate-800 mb-6">ç‰¹è¨“çµæŸï¼</h2>
                            {uniqueMistakes.length === 0 ? <div className="bg-green-50 p-8 rounded-3xl text-green-700 font-bold mb-8 border border-green-200">å¤ªæ£’äº†ï¼é€™æ¬¡å…¨å°ï¼</div> : 
                            <div className="text-left bg-rose-50 p-6 rounded-3xl mb-8 border border-rose-100 max-h-60 overflow-y-auto custom-scrollbar"><h3 className="font-bold text-rose-600 mb-4">âš ï¸ éœ€è¦è¤‡ç¿’ï¼š</h3>{uniqueMistakes.map((m, i) => <div key={i} className="mb-2 font-black text-slate-800">{m}</div>)}</div>}
                            <button onClick={startQuiz} className="w-full bg-slate-800 text-white text-xl font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-all">å†ä¾†ä¸€æ¬¡</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-2xl mx-auto relative overflow-hidden">
                    {praise && <div className="absolute inset-0 flex items-center justify-center z-50 pointer-events-none"><div className="praise-anim bg-yellow-400 text-yellow-900 px-8 py-4 rounded-3xl text-4xl font-black shadow-2xl border-4 border-white transform rotate-[-5deg]">{praise}</div></div>}
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-3 px-5 py-3 bg-white rounded-2xl font-bold text-slate-600 shadow-sm border border-slate-100"><span>Q {qIndex + 1} / {questions.length}</span></div>
                    </div>
                    <div className="w-full bg-slate-200 h-2 rounded-full mb-6 overflow-hidden"><div className="bg-indigo-500 h-full transition-all duration-500" style={{width: `${progress}%`}}></div></div>
                    <div className="bg-white rounded-[2.5rem] shadow-xl border border-slate-200 overflow-hidden relative">
                        <div className="bg-slate-50 p-8 border-b border-slate-100 text-center relative">
                            <div className="inline-block px-3 py-1 rounded-full bg-indigo-100 text-indigo-600 text-xs font-black uppercase tracking-widest mb-3">{currentQ.title}</div>
                            <h2 className="text-3xl font-black text-slate-800 leading-snug">{currentQ.text}</h2>
                            {currentQ.isScale && <ScaleView weight={currentQ.val} max={currentQ.max} unit={currentQ.unit} />}
                            {currentQ.isBeaker && <BeakerView capacity={currentQ.cap} level={currentQ.lvl} label="é‡æ¯ Q" />}
                            {currentQ.isAbacus && <AbacusView number={currentQ.val} />}
                            {currentQ.isPictogram && <PictogramView data={currentQ.data} title="3Eç­èˆˆè¶£ç­çµ±è¨ˆ" />}
                        </div>
                        <div className="p-8 min-h-[350px] flex flex-col">
                            <div className="text-center text-xs font-bold text-slate-400 mb-6 uppercase tracking-widest mb-2">Step {stepIndex + 1} of {currentQ.steps.length}</div>
                            {renderStep()}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
