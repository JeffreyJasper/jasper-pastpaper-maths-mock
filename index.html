<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jasper 數學模擬試卷 V8.2</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Roboto+Mono:wght@500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f9ff; user-select: none; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .digit-input { width: 100%; height: 100%; text-align: center; font-family: 'Roboto Mono', monospace; font-weight: 700; font-size: 1.5rem; border: 2px solid #cbd5e1; border-radius: 0.5rem; background-color: white; color: #1e293b; transition: all 0.2s; }
        .digit-input:focus { border-color: #6366f1; outline: none; background-color: #eef2ff; transform: scale(1.05); z-index: 10; }
        .digit-input:disabled { background-color: #f8fafc; border-color: #e2e8f0; color: #94a3b8; }
        
        .carry-input { width: 100%; height: 30px; text-align: center; font-size: 0.9rem; font-weight: bold; color: #ef4444; background-color: transparent; border: 1px dashed #fda4af; border-radius: 4px; z-index: 5; margin-bottom: 2px; }
        .calc-line { height: 4px; background-color: #334155; border-radius: 2px; margin-top: 2px; margin-bottom: 4px; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @keyframes popUp { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .praise-anim { animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = {
            Clock: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Check: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>,
            Brain: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Idea: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.9 1.2 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
        };

        const PRAISE_WORDS = ["太棒了！", "Jasper 厲害！", "思路正確！", "做得好！", "完美拆解！"];

        // --- 組件：標準直式 ---
        const VerticalAddSub = ({ n1, n2, op, onComplete }) => {
            const digits1 = n1.toString().padStart(5, ' ').split('');
            const digits2 = n2.toString().padStart(5, ' ').split('');
            const [inputs, setInputs] = useState(['', '', '', '', '']);
            const [carries, setCarries] = useState(['', '', '', '', '']);
            const [errorMsg, setErrorMsg] = useState('');
            const correctAns = op === '+' ? n1 + n2 : n1 - n2;
            const correctDigits = correctAns.toString().padStart(5, ' ').split('');

            const checkAnswer = () => {
                let userNum = parseInt(inputs.map(d => d === '' ? ' ' : d).join('').replace(/\s/g, ''));
                if (userNum === correctAns) onComplete(correctAns);
                else setErrorMsg('請檢查答案和進退位算草。');
            };

            return (
                <div className="bg-white p-6 rounded-2xl border-2 border-slate-200 shadow-sm max-w-md mx-auto animate-in zoom-in-95">
                    <div className="grid grid-cols-6 gap-1 font-mono">
                        <div className="col-span-1"></div>{digits1.map((d, i) => <div key={`d1-${i}`} className="h-10 flex items-center justify-center text-3xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-1 text-3xl font-black text-slate-400 flex items-center justify-end pr-2">{op}</div>{digits2.map((d, i) => <div key={`d2-${i}`} className="h-10 flex items-center justify-center text-3xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-1"></div>{carries.map((v, i) => <div key={`c-${i}`} className="flex items-end justify-center"><input className="carry-input" value={v} onChange={e=>setCarries(p=>{const n=[...p];n[i]=e.target.value.slice(-2);return n;})} /></div>)}
                        <div className="col-span-6 calc-line"></div>
                        <div className="col-span-1"></div>{inputs.map((v, i) => <input key={`in-${i}`} type="number" className={`digit-input h-14 ${v!=='' && correctDigits[i]!==' ' && v!==correctDigits[i] ? 'bg-red-50 border-red-300' : ''}`} value={v} disabled={correctDigits[i]===' '} onChange={e => {setInputs(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;}); setErrorMsg('');}} />)}
                    </div>
                    {errorMsg && <div className="mt-3 text-center text-rose-500 font-bold text-sm bg-rose-50 p-2 rounded">{errorMsg}</div>}
                    <button onClick={checkAnswer} className="mt-5 w-full bg-indigo-600 text-white py-3 rounded-xl font-black active:scale-95">檢查直式</button>
                </div>
            );
        };

        // --- 組件：連式直式 ---
        const VerticalContinuous = ({ n1, n2, n3, op1, op2, onComplete }) => {
            const digits1 = n1.toString().padStart(5, ' ').split('');
            const digits2 = n2.toString().padStart(5, ' ').split('');
            const digits3 = n3.toString().padStart(5, ' ').split('');
            const step1Ans = op1 === '+' ? n1 + n2 : n1 - n2;
            const digitsStep1 = step1Ans.toString().padStart(5, ' ').split('');
            const finalAns = op2 === '+' ? step1Ans + n3 : step1Ans - n3;
            const digitsFinal = finalAns.toString().padStart(5, ' ').split('');

            const [inputs1, setInputs1] = useState(['', '', '', '', '']); const [carries1, setCarries1] = useState(['', '', '', '', '']);
            const [inputs2, setInputs2] = useState(['', '', '', '', '']); const [carries2, setCarries2] = useState(['', '', '', '', '']);
            const [errorMsg, setErrorMsg] = useState('');

            const checkAnswer = () => {
                let u1 = parseInt(inputs1.map(d => d===''?' ':d).join('').replace(/\s/g, ''));
                let u2 = parseInt(inputs2.map(d => d===''?' ':d).join('').replace(/\s/g, ''));
                if (u1 !== step1Ans) { setErrorMsg('第一步算錯了 (中間那行)'); return; }
                if (u2 !== finalAns) { setErrorMsg('最後答案算錯了'); return; }
                onComplete(finalAns);
            };

            return (
                <div className="bg-white p-6 rounded-2xl border-2 border-slate-200 shadow-sm max-w-md mx-auto animate-in zoom-in-95">
                    <div className="grid grid-cols-6 gap-1 font-mono">
                        <div className="col-span-1"></div>{digits1.map((d, i) => <div key={`d1-${i}`} className="h-8 flex items-center justify-center text-2xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-1 text-2xl font-black text-slate-400 flex items-center justify-end pr-2">{op1}</div>{digits2.map((d, i) => <div key={`d2-${i}`} className="h-8 flex items-center justify-center text-2xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-1"></div>{carries1.map((v, i) => <div key={`c1-${i}`} className="flex items-end justify-center"><input className="carry-input" value={v} onChange={e=>setCarries1(p=>{const n=[...p];n[i]=e.target.value.slice(-2);return n;})} /></div>)}
                        <div className="col-span-6 calc-line"></div>
                        <div className="col-span-1"></div>{inputs1.map((v, i) => <input key={`in1-${i}`} type="number" className={`digit-input h-10 ${v!=='' && digitsStep1[i]!==' ' && v!==digitsStep1[i] ? 'bg-red-50 border-red-300' : ''}`} value={v} disabled={digitsStep1[i]===' '} onChange={e => {setInputs1(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;}); setErrorMsg('');}} />)}
                        <div className="col-span-1 text-2xl font-black text-slate-400 mt-2 flex items-center justify-end pr-2">{op2}</div>{digits3.map((d, i) => <div key={`d3-${i}`} className="h-8 flex items-center justify-center text-2xl font-black text-slate-700 mt-2">{d}</div>)}
                        <div className="col-span-1"></div>{carries2.map((v, i) => <div key={`c2-${i}`} className="flex items-end justify-center mt-1"><input className="carry-input" value={v} onChange={e=>setCarries2(p=>{const n=[...p];n[i]=e.target.value.slice(-2);return n;})} /></div>)}
                        <div className="col-span-6 calc-line"></div>
                        <div className="col-span-1"></div>{inputs2.map((v, i) => <input key={`in2-${i}`} type="number" className={`digit-input h-10 ${v!=='' && digitsFinal[i]!==' ' && v!==digitsFinal[i] ? 'bg-red-50 border-red-300' : ''}`} value={v} disabled={digitsFinal[i]===' '} onChange={e => {setInputs2(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;}); setErrorMsg('');}} />)}
                    </div>
                    {errorMsg && <div className="mt-3 text-center text-rose-500 font-bold text-sm bg-rose-50 p-2 rounded">{errorMsg}</div>}
                    <button onClick={checkAnswer} className="mt-5 w-full bg-indigo-600 text-white py-3 rounded-xl font-black active:scale-95">檢查全式</button>
                </div>
            );
        };

        // --- 組件：直式乘法 ---
        const VerticalMulti = ({ n1, n2, onComplete }) => {
            const digits1 = n1.toString().padStart(4, ' ').split('');
            const [inputs, setInputs] = useState(['', '', '', '', '']); 
            const [carries, setCarries] = useState(['', '', '', '']); 
            const [errorMsg, setErrorMsg] = useState('');
            const correctAns = n1 * n2;
            const correctDigits = correctAns.toString().padStart(5, ' ').split('');

            const checkAnswer = () => {
                let userNum = parseInt(inputs.map(d => d === '' ? ' ' : d).join('').replace(/\s/g, ''));
                if (userNum === correctAns) onComplete(correctAns);
                else setErrorMsg('乘法算錯囉！進位寫在上方小格。');
            };

            return (
                <div className="bg-white p-6 rounded-2xl border-2 border-slate-200 shadow-sm max-w-md mx-auto animate-in zoom-in-95">
                    <div className="grid grid-cols-6 gap-1 font-mono">
                        <div className="col-span-2"></div>{carries.map((v, i) => <input key={`mc-${i}`} className="carry-input" placeholder="進" value={v} onChange={e=>setCarries(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;})} />)}
                        <div className="col-span-2"></div>{digits1.map((d, i) => <div key={`md1-${i}`} className="h-10 flex items-center justify-center text-3xl font-black text-slate-700">{d}</div>)}
                        <div className="col-span-1 text-right text-3xl font-black text-slate-400 flex items-center justify-end pr-2">×</div><div className="col-span-4"></div><div className="col-span-1 h-10 flex items-center justify-center text-3xl font-black text-slate-700">{n2}</div>
                        <div className="col-span-6 calc-line"></div>
                        <div className="col-span-1"></div>{inputs.map((v, i) => <input key={`min-${i}`} type="number" className={`digit-input h-14 ${v!=='' && correctDigits[i]!==' ' && v!==correctDigits[i] ? 'bg-red-50 border-red-300 text-red-600' : ''}`} value={v} disabled={correctDigits[i]===' '} onChange={e => {setInputs(p=>{const n=[...p];n[i]=e.target.value.slice(-1);return n;}); setErrorMsg('');}} />)}
                    </div>
                    {errorMsg && <div className="mt-3 text-center text-rose-500 font-bold text-sm bg-rose-50 p-2 rounded">{errorMsg}</div>}
                    <button onClick={checkAnswer} className="mt-5 w-full bg-indigo-600 text-white py-3 rounded-xl font-black active:scale-95">檢查乘法</button>
                </div>
            );
        };

        // --- 組件：時鐘 ---
        const ClockFace = ({ h, m, interactive, onTimeChange, onConfirm }) => {
            const hourAngle = (h * 30) + (m * 0.5);
            const minuteAngle = m * 6;
            return (
                <div className="flex flex-col items-center">
                    <svg width="180" height="180" viewBox="0 0 200 200" className="drop-shadow-lg my-4">
                        <circle cx="100" cy="100" r="95" fill="white" stroke="#334155" strokeWidth="6" />
                        {[...Array(12)].map((_, i) => <text key={i} x={100+75*Math.sin((i+1)*Math.PI/6)} y={105-75*Math.cos((i+1)*Math.PI/6)} textAnchor="middle" className="font-bold text-lg font-mono" fill="#64748b">{i+1}</text>)}
                        <line x1="100" y1="100" x2={100+50*Math.sin(hourAngle*Math.PI/180)} y2={100-50*Math.cos(hourAngle*Math.PI/180)} stroke="#1e293b" strokeWidth="6" strokeLinecap="round" />
                        <line x1="100" y1="100" x2={100+75*Math.sin(minuteAngle*Math.PI/180)} y2={100-75*Math.cos(minuteAngle*Math.PI/180)} stroke="#ef4444" strokeWidth="4" strokeLinecap="round" />
                        <circle cx="100" cy="100" r="5" fill="#1e293b" />
                    </svg>
                    {interactive && (
                        <div className="flex flex-col w-full gap-3">
                            <div className="flex gap-2 justify-center">
                                <button onClick={() => onTimeChange(h===12?1:h+1, m)} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg font-bold shadow hover:bg-slate-300">調時針</button>
                                <button onClick={() => onTimeChange(h, m===0?30:0)} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg font-bold shadow hover:bg-slate-300">調分針</button>
                            </div>
                            <button onClick={onConfirm} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-black shadow-md active:scale-95">確認時間</button>
                        </div>
                    )}
                </div>
            );
        };

        // --- 組件：量杯 ---
        const BeakerView = ({ capacity = 1000, level, label }) => {
            const heightPerc = (level / capacity) * 100;
            return (
                <div className="flex flex-col items-center mx-4 my-6">
                    <div className="relative w-40 h-56 border-b-4 border-x-4 border-slate-700 rounded-b-xl bg-white overflow-hidden shadow-md">
                        <div className="absolute bottom-0 w-full bg-blue-400 opacity-80 transition-all duration-1000 border-t-2 border-blue-600" style={{height: `${heightPerc}%`}}></div>
                        <div className="absolute right-0 top-0 h-full w-full pointer-events-none">
                            {[0.25, 0.5, 0.75, 1].map((p, i) => (
                                <div key={i} className="absolute w-full flex items-center justify-end pr-2" style={{bottom: `${p*100}%`, transform: 'translateY(50%)'}}>
                                    <span className="text-sm font-black text-slate-600 mr-2 bg-white/80 px-1 rounded">{Math.round(capacity * p)}</span>
                                    <div className="w-8 h-1 bg-slate-800"></div>
                                </div>
                            ))}
                        </div>
                        <div className="absolute top-2 left-2 font-bold text-sm text-slate-500">mL</div>
                    </div>
                </div>
            );
        };

        // --- 組件：算柱 ---
        const AbacusView = ({ number }) => {
            const digits = number.toString().padStart(5, '0').split('');
            const places = ['萬', '千', '百', '十', '個'];
            return (
                <div className="flex justify-center gap-3 my-6 bg-amber-50 p-6 rounded-2xl border-2 border-amber-200 shadow-sm">
                    {digits.map((d, i) => (
                        <div key={i} className="flex flex-col items-center">
                            <div className="h-32 w-1 bg-slate-400 relative mb-2">
                                {[...Array(parseInt(d))].map((_, j) => (
                                    <div key={j} className="absolute w-8 h-5 bg-amber-600 rounded-full left-1/2 transform -translate-x-1/2 border border-amber-800 shadow-sm z-10" style={{bottom: j * 20}}></div>
                                ))}
                            </div>
                            <div className="w-10 h-10 flex items-center justify-center border-2 border-slate-600 bg-white font-bold text-slate-700 rounded-lg shadow-sm text-lg">{places[i]}</div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- 組件：象形圖 ---
        const PictogramView = ({ data }) => {
            return (
                <div className="my-6 w-full max-w-md mx-auto bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div className="flex justify-end mb-4 pr-4"><div className="flex items-center gap-2 bg-slate-100 px-3 py-1 rounded-full text-xs font-bold text-slate-600"><div className="w-4 h-4 rounded-full bg-blue-500"></div> = 1 人</div></div>
                    <div className="flex justify-around items-end h-56 border-b-2 border-slate-800 pb-2 px-2">
                        {data.map((item, i) => (
                            <div key={i} className="flex flex-col items-center gap-2 w-1/5">
                                <div className="flex flex-col-reverse gap-1 h-full justify-start">
                                    {[...Array(item.value)].map((_, j) => <div key={j} className="w-6 h-6 rounded-full bg-blue-500 border-2 border-white shadow-sm ring-1 ring-blue-200"></div>)}
                                </div>
                                <div className="mt-2 text-sm font-bold text-slate-700 writing-mode-vertical">{item.name}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 核心：生成題目資料 ---
        const generateQuizData = () => {
            const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);

            const q1 = (() => { const n = rand(1,9)*10000 + rand(1,9)*1000 + rand(1,9)*10 + rand(1,9); return { id: 1, title: '數字讀法', text: `「${n}」讀作什麼？`, steps: [{ type: 'LOGIC', text: '選擇正確的讀法', options: shuffle(['正確的五位數讀法', '錯讀法A', '錯讀法B', '錯讀法C']), ans: '正確的五位數讀法' }] }; })();
            const q2 = (() => { const b = rand(30000, 39000); const a1=b, a2=b+rand(10,100), a3=b-rand(10,100); const sorted=[a3, a1, a2].sort((a,b)=>a-b); return { id: 2, title: '數字排列', text: `把 ${a1}, ${a2}, ${a3} 由小至大排列`, steps: [{type:'INPUT_CHECK', label: '最小的數', correct: sorted[0].toString()}, {type:'INPUT_CHECK', label: '最大的數', correct: sorted[2].toString()}]}; })();
            const q3 = (() => { const n = rand(10000, 90000); return { id: 3, title: '算柱', text: '讀出算柱上的數字', isAbacus: true, val: n, steps: [{type:'INPUT_CHECK', label: '答案是？', correct: n.toString()}] }; })();
            const q4 = (() => { const a=rand(5000,9000), b=rand(1000,4999); return { id: 4, title: '四位數減法', text: `${a} - ${b} = ?`, steps: [{ type: 'SUB', n1: a, n2: b, hint: '用直式計算減法' }]}; })();
            const q5 = (() => { const a=rand(1000,4000), b=rand(2000,5000); return { id: 5, title: '四位數加法', text: `${a} + ${b} = ?`, steps: [{ type: 'ADD', n1: a, n2: b, hint: '用直式計算加法' }]}; })();
            const q6 = (() => { return { id: 6, title: '貨幣轉換', text: `30元 - (4元4角 + 12元7角) = ?`, steps: [{ type: 'LOGIC', text: '全部轉做「角」會比較易計，30元 = ?', options: shuffle(['300角', '30角', '3角', '3000角']), ans: '300角' }, { type: 'ADD', n1: 44, n2: 127, hint: '先算括弧內：44角 + 127角' }, { type: 'SUB', n1: 300, n2: 171, hint: '用 300角 減去括弧答案' }]}; })();
            const q7 = (() => { const b=rand(3,9); return { id: 7, title: '連乘法', text: `20 × ${b} × 5 = ?`, steps: [{ type: 'LOGIC', text: '先算哪兩個數會變成 100？', options: shuffle([`20 × 5`, `20 × ${b}`, `${b} × 5`, `順序算`]), ans: `20 × 5` }, { type: 'INPUT_CHECK', label: `100 × ${b} = ?`, correct: (100*b).toString() }]}; })();
            const q8 = (() => { const a=4037, b=3219, target=2717; return { id: 8, title: '代數運算', text: `${a} + ${b} - ? = ${target}`, steps: [{ type: 'ADD', n1: a, n2: b, hint: '先算出前面的加法' }, { type: 'SUB', n1: 7256, n2: target, hint: '用加法答案減去結果，找出問號' }]}; })();
            const q9 = (() => { const a=1062, b=3131, c=1508; return { id: 9, title: '連加文字題', text: `圖書館有三層書：${a}本, ${b}本, ${c}本。共有多少？`, steps: [{ type: 'CONTINUOUS', n1: a, n2: b, n3: c, op1: '+', op2: '+', hint: '用連式直式將三層加起來' }]}; })();
            const q10 = (() => { const pay=5000, cost=2016; return { id: 10, title: '找贖 (乘減混合)', text: `買兩部吸塵機(每部$${cost})，付$${pay}，找回多少？`, steps: [{ type: 'MULTI', n1: cost, n2: 2, hint: '先算 2 部的價錢' }, { type: 'SUB', n1: pay, n2: cost*2, hint: '減去總價算找贖' }]}; })();
            const q11 = (() => { const a=1356, b=444, c=44; return { id: 11, title: '連續減法', text: `${a} - ${b} - ${c} = ?`, steps: [{ type: 'CONTINUOUS', n1: a, n2: b, n3: c, op1: '-', op2: '-', hint: '連減直式：先算上層，再算下層' }]}; })();
            const q12 = (() => { const a=654, b=228, c=97; return { id: 12, title: '括號減法', text: `${a} - (${b} + ${c}) = ?`, steps: [{ type: 'ADD', n1: b, n2: c, hint: '先算括弧' }, { type: 'SUB', n1: a, n2: b+c, hint: '用總數減去括弧答案' }]}; })();
            const q13 = { id: 13, title: '連續除法', text: `200 ÷ 8 ÷ 5 = ?`, steps: [{ type: 'LOGIC', text: '除以 8 再除以 5，等於除以幾多？', options: shuffle(['除以 40', '除以 13', '除以 3']), ans: '除以 40' }, { type: 'INPUT_CHECK', label: `200 ÷ 40 = ?`, correct: '5' }] };
            const q14 = { id: 14, title: '除法驗算', text: `「 ? ÷ 6 = 45 ... 2 」，求被除數 ?`, steps: [{ type: 'MULTI', n1: 45, n2: 6, hint: '被除數 = 商 × 除數 + 餘數。先算乘' }, { type: 'INPUT_CHECK', label: `270 + 2 = ?`, correct: '272' }] };
            const q15 = { id: 15, title: '除法陷阱', text: `計算「 613 ÷ 3 」`, steps: [{ type: 'LOGIC', text: '十位 1÷3 不夠除，商的十位要寫什麼？', options: shuffle(['寫 0', '不寫', '寫 1']), ans: '寫 0' }, { type: 'LOGIC', text: '最後答案是？', options: shuffle(['204 ... 1', '24 ... 1', '204']), ans: '204 ... 1' }] };
            const q16 = { id: 16, title: '單位轉換', text: `長 2 米的絲帶，平均分 4 段，每段長幾多「厘米」？`, steps: [{ type: 'INPUT_CHECK', label: `2 米 = ? 厘米`, correct: '200' }, { type: 'INPUT_CHECK', label: `200 ÷ 4 = ?`, correct: '50' }] };
            const q17 = { id: 17, title: '日期計算', text: `王叔叔日薪 $950。由 1月15日 工作至 1月17日，共賺多少？`, steps: [{ type: 'LOGIC', text: '15日至17日，總共工作了幾多天？', options: shuffle(['3天', '2天', '4天']), ans: '3天' }, { type: 'MULTI', n1: 950, n2: 3, hint: '直式計算 950 × 3' }] };
            const q18 = (() => { const dad=2942, mom=2203, diff=172; return { id: 18, title: '三數比較題', text: `爸有$${dad}，媽有$${mom}。媽比表姐少$${diff}。問爸比表姐多幾元？`, steps: [{type:'ADD', n1: mom, n2: diff, hint: '媽比表姐少即表姐較多，先算表姐的錢'}, {type:'SUB', n1: dad, n2: mom+diff, hint: '算爸和表姐的差額'}] }; })();
            const q19 = { id: 19, title: '除法應用', text: `有糖 307 粒，每 8 粒裝一袋，最多裝多少袋？`, steps: [{ type: 'LOGIC', text: '307 ÷ 8 = 38...3，代表什麼？', options: shuffle(['裝了 38 袋，剩 3 粒', '裝了 3 袋，剩 38 粒']), ans: '裝了 38 袋，剩 3 粒' }, { type: 'INPUT_CHECK', label: `最多可裝幾多袋？`, correct: '38' }] };
            const q20 = { id: 20, title: '隱藏人數', text: `小明和 4 位朋友去食自助餐，每人 $140。共付多少？`, steps: [{ type: 'LOGIC', text: '「小明和 4 位朋友」，總共有幾多人？', options: shuffle(['5人', '4人', '3人']), ans: '5人' }, { type: 'MULTI', n1: 140, n2: 5, hint: '用直式算總金額' }] };
            const q21 = (() => { const c=1000; const l=[250, 500, 750][rand(0,2)]; return { id: 21, title: '讀取容量', text: '量杯中的水有多少？', isBeaker: true, cap: c, lvl: l, steps: [{type:'INPUT_CHECK', label: '水位是(mL)？', correct: l.toString()}] }; })();
            const q22 = (() => { const data = [{name:'游泳', value:rand(2,6)}, {name:'繪畫', value:rand(3,8)}, {name:'跳舞', value:rand(1,5)}]; const diff = Math.abs(data[0].value - data[1].value); const maxName = data.reduce((p, c) => p.value > c.value ? p : c).name; return { id: 22, title: '象形圖分析', text: '觀察統計圖。', isPictogram: true, data: data, steps: [{type:'LOGIC', text: `哪一項活動最受歡迎？`, options: shuffle([data[0].name, data[1].name, data[2].name]), ans: maxName}, {type:'INPUT_CHECK', label: `游泳和繪畫相差幾人？`, correct: diff.toString()}] }; })();
            
            // 文具圖表題 (放大的圖案)
            const q23 = (() => {
                const priceA=rand(25,29), priceB=rand(30,35), priceC=rand(15,20);
                const mostExpensive = Math.max(priceA, priceB, priceC);
                const filePrice = rand(60,70);
                return { id: 23, title: '購物 (圖表)', text: `浩文買了 3 本「最貴」的筆記簿，和 3 個 $${filePrice} 的文件袋。共付多少？`, extraInfo: {A: priceA, B: priceB, C: priceC}, steps: [
                    { type: 'MULTI', n1: mostExpensive, n2: 3, hint: `先算 3 本最貴筆記簿的價錢 ($${mostExpensive} × 3)` }, 
                    { type: 'MULTI', n1: filePrice, n2: 3, hint: `再算 3 個文件袋的價錢 ($${filePrice} × 3)` },
                    { type: 'ADD', n1: mostExpensive*3, n2: filePrice*3, hint: '將兩樣貨品的總價加起來' }
                ]};
            })();

            // 打亂後返回全部 23 題 (精簡版)
            return shuffle([q1, q2, q3, q4, q5, q6, q7, q8, q9, q10, q11, q12, q13, q14, q15, q16, q17, q18, q19, q20, q21, q22, q23]);
        };

        const App = () => {
            const [mode, setMode] = useState('MENU');
            const [questions, setQuestions] = useState([]);
            const [qIndex, setQIndex] = useState(0);
            const [stepIndex, setStepIndex] = useState(0);
            const [mistakeList, setMistakeList] = useState([]); 
            const [timer, setTimer] = useState(0);
            const [clockState, setClockState] = useState({h: 12, m: 0});
            const [praise, setPraise] = useState('');
            const [showHint, setShowHint] = useState(false);
            const timerRef = useRef(null);

            const startQuiz = () => {
                setQuestions(generateQuizData());
                setQIndex(0); setStepIndex(0); setMistakeList([]); setTimer(0); setMode('GAME');
            };

            const currentQ = questions[qIndex] || {};
            const currentStep = currentQ.steps ? currentQ.steps[stepIndex] : {};
            const progress = questions.length > 0 ? ((qIndex) / questions.length) * 100 : 0;

            useEffect(() => {
                if (mode === 'GAME') timerRef.current = setInterval(() => setTimer(t => t + 1), 1000);
                else clearInterval(timerRef.current);
                return () => clearInterval(timerRef.current);
            }, [mode]);

            useEffect(() => {
                if (mode === 'GAME' && currentStep.type === 'CLOCK_INTERACTIVE') setClockState({ h: currentStep.startH || 12, m: currentStep.startM || 0 });
                setShowHint(false);
            }, [qIndex, stepIndex, mode, questions]);

            const showPraiseText = () => {
                setPraise(PRAISE_WORDS[Math.floor(Math.random() * PRAISE_WORDS.length)]);
                setTimeout(() => setPraise(''), 1500);
            };

            const markMistake = () => {
                setMistakeList(prev => {
                    const exists = prev.find(p => p.qId === currentQ.id);
                    if (!exists) return [...prev, { qId: currentQ.id, title: currentQ.title }];
                    return prev;
                });
            };

            const nextStep = () => {
                if (stepIndex < currentQ.steps.length - 1) setStepIndex(p => p + 1);
                else {
                    if (qIndex < questions.length - 1) { setQIndex(q => q + 1); setStepIndex(0); } 
                    else setMode('RESULT');
                }
            };

            const handleLogicChoice = (opt) => { if (opt === currentStep.ans) { showPraiseText(); nextStep(); } else { markMistake(); alert(`選錯了！試試其他的。`); } };
            const handleCalcComplete = () => { showPraiseText(); nextStep(); };
            const handleInputCheck = (val) => { if (val.trim() === currentStep.correct) { showPraiseText(); nextStep(); } else { markMistake(); alert(`答案不對喔！`); } };
            const handleTimeUpdate = (newH, newM) => setClockState({h: newH, m: newM});
            const handleClockConfirm = () => {
                let isCorrect = false;
                if (clockState.m === currentStep.targetM && (clockState.h === currentStep.targetH || (clockState.h > 12 && clockState.h - 12 === currentStep.targetH) || (currentStep.targetH > 12 && clockState.h === currentStep.targetH - 12))) isCorrect = true;
                if (isCorrect) { showPraiseText(); nextStep(); } else { markMistake(); alert(`時間不對，請再調一次！`); }
            };

            const renderHint = (hintText) => {
                if (!hintText) return null;
                return (
                    <div className="mb-4 text-center h-10 flex items-center justify-center">
                        {!showHint ? <button onClick={() => setShowHint(true)} className="bg-slate-100 text-slate-500 px-4 py-2 rounded-full font-bold text-sm shadow-sm flex gap-2"><Icon.Idea/> 點擊看提示</button> : <div className="bg-yellow-50 text-yellow-800 px-4 py-2 rounded-full font-bold text-sm flex gap-2 border border-yellow-200"><Icon.Idea/> 提示：{hintText}</div>}
                    </div>
                );
            };

            const renderStep = () => {
                const k = `${qIndex}-${stepIndex}`; 
                switch(currentStep.type) {
                    case 'LOGIC': return <div key={k} className="grid gap-4"><div className="bg-indigo-50 p-4 rounded-xl text-indigo-800 font-bold flex gap-2"><Icon.Brain/> {currentStep.text}</div>{currentStep.options.map((o, i) => <button key={i} onClick={() => handleLogicChoice(o)} className="p-4 border-2 border-slate-200 rounded-xl font-bold hover:bg-indigo-100 text-left">{o}</button>)}</div>;
                    case 'ADD': case 'SUB': return <div key={k}>{renderHint(currentStep.hint)}<VerticalAddSub n1={currentStep.n1} n2={currentStep.n2} op={currentStep.type==='ADD'?'+':'-'} onComplete={handleCalcComplete} /></div>;
                    case 'MULTI': return <div key={k}>{renderHint(currentStep.hint)}<VerticalMulti n1={currentStep.n1} n2={currentStep.n2} onComplete={handleCalcComplete} /></div>;
                    case 'CONTINUOUS': return <div key={k}>{renderHint(currentStep.hint)}<VerticalContinuous n1={currentStep.n1} n2={currentStep.n2} n3={currentStep.n3} op1={currentStep.op1} op2={currentStep.op2} onComplete={handleCalcComplete} /></div>;
                    case 'INPUT_CHECK': return <div key={k} className="flex flex-col gap-4"><label className="font-bold text-slate-700 text-center">{currentStep.label}</label>{renderHint(currentStep.hint)}<input type="text" className="p-4 border-2 border-slate-300 rounded-xl text-center text-2xl font-black" placeholder="輸入答案" onKeyDown={(e)=>{if(e.key==='Enter') handleInputCheck(e.target.value)}} /><button className="bg-slate-800 text-white p-4 rounded-xl font-black" onClick={(e)=>handleInputCheck(e.target.previousSibling.value)}>確定</button></div>;
                    case 'CLOCK_INTERACTIVE': return <div key={k}>{renderHint(currentStep.hint)}<ClockFace h={clockState.h} m={clockState.m} interactive={true} onTimeChange={handleTimeUpdate} onConfirm={handleClockConfirm}/></div>;
                    default: return null;
                }
            };

            if (mode === 'MENU') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white rounded-[2.5rem] p-10 max-w-lg w-full shadow-2xl text-center border border-slate-100">
                        <div className="inline-block p-4 bg-indigo-100 rounded-full text-indigo-600 mb-6"><Icon.Brain/></div>
                        <h1 className="text-3xl font-black text-slate-800 mb-2">Jasper 數學 V8.2</h1>
                        <p className="text-indigo-500 font-bold mb-8">Past Paper 完美修復版</p>
                        <button onClick={startQuiz} className="w-full bg-indigo-600 text-white text-xl font-black py-5 rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-95">開始特訓</button>
                    </div>
                </div>
            );

            if (mode === 'RESULT') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white rounded-[2.5rem] p-10 max-w-lg w-full shadow-2xl text-center border border-slate-100">
                            <h2 className="text-4xl font-black text-slate-800 mb-6">全卷完成！</h2>
                            {mistakeList.length === 0 ? <div className="bg-green-50 p-8 rounded-3xl text-green-700 font-bold mb-8 border border-green-200">太棒了！這次全對！</div> : 
                            <div className="text-left bg-rose-50 p-6 rounded-3xl mb-8 border border-rose-100 max-h-60 overflow-y-auto"><h3 className="font-bold text-rose-600 mb-4">⚠️ 錯誤回顧：</h3>{mistakeList.map((m, i) => <div key={i} className="mb-2 font-black text-slate-800">{m.title}</div>)}</div>}
                            <button onClick={startQuiz} className="w-full bg-slate-800 text-white text-xl font-black py-4 rounded-2xl shadow-xl active:scale-95">再來一次</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-2xl mx-auto relative overflow-hidden">
                    {praise && <div className="absolute inset-0 flex items-center justify-center z-50 pointer-events-none"><div className="praise-anim bg-yellow-400 text-yellow-900 px-8 py-4 rounded-3xl text-4xl font-black shadow-2xl border-4 border-white transform rotate-[-5deg]">{praise}</div></div>}
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-3 px-5 py-3 bg-white rounded-2xl font-bold text-slate-600 shadow-sm border border-slate-100"><span>Q {qIndex + 1} / {questions.length}</span></div>
                        <div className="flex items-center gap-3 px-5 py-3 bg-white rounded-2xl font-bold text-indigo-600 shadow-sm border border-slate-100"><Icon.Clock/> <span>{Math.floor(timer/60)}:{timer%60 < 10 ? '0'+timer%60 : timer%60}</span></div>
                    </div>
                    <div className="w-full bg-slate-200 h-2 rounded-full mb-6 overflow-hidden"><div className="bg-indigo-500 h-full transition-all duration-500" style={{width: `${progress}%`}}></div></div>
                    <div className="bg-white rounded-[2.5rem] shadow-xl border border-slate-200 overflow-hidden relative">
                        <div className="bg-slate-50 p-8 border-b border-slate-100 text-center relative">
                            <div className="inline-block px-3 py-1 rounded-full bg-indigo-100 text-indigo-600 text-xs font-black uppercase tracking-widest mb-3">{currentQ.title}</div>
                            <h2 className="text-2xl sm:text-3xl font-black text-slate-800 leading-snug">{currentQ.text}</h2>
                            {currentQ.isAbacus && <AbacusView number={currentQ.val} />}
                            {currentQ.isBeaker && <BeakerView capacity={currentQ.cap} level={currentQ.lvl} />}
                            {currentQ.isPictogram && <PictogramView data={currentQ.data} title="興趣班統計" />}
                            {currentQ.extraInfo && (
                                <div className="mt-8 flex justify-center gap-4 sm:gap-8 relative">
                                    <div className="bg-white border-2 border-slate-200 border-l-[12px] border-l-amber-400 w-24 sm:w-28 h-32 sm:h-36 flex flex-col items-center justify-center rounded-r-2xl shadow-md transform -rotate-3">
                                        <span className="text-[10px] sm:text-xs font-black text-slate-400 mb-1 uppercase tracking-widest">款式 A</span>
                                        <span className="text-2xl sm:text-3xl font-black text-slate-700">${currentQ.extraInfo.A}</span>
                                    </div>
                                    <div className="bg-white border-2 border-slate-200 border-l-[12px] border-l-rose-400 w-28 sm:w-32 h-36 sm:h-40 flex flex-col items-center justify-center rounded-r-2xl shadow-xl z-10 scale-105">
                                        <span className="text-[10px] sm:text-xs font-black text-slate-400 mb-1 uppercase tracking-widest">款式 B</span>
                                        <span className="text-3xl sm:text-4xl font-black text-rose-600">${currentQ.extraInfo.B}</span>
                                    </div>
                                    <div className="bg-white border-2 border-slate-200 border-l-[12px] border-l-sky-400 w-24 sm:w-28 h-32 sm:h-36 flex flex-col items-center justify-center rounded-r-2xl shadow-md transform rotate-3">
                                        <span className="text-[10px] sm:text-xs font-black text-slate-400 mb-1 uppercase tracking-widest">款式 C</span>
                                        <span className="text-2xl sm:text-3xl font-black text-slate-700">${currentQ.extraInfo.C}</span>
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="p-8 min-h-[350px] flex flex-col">
                            <div className="text-center text-xs font-bold text-slate-400 mb-6 uppercase tracking-widest mb-2">Step {stepIndex + 1} of {currentQ.steps.length}</div>
                            {renderStep()}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
